# MySQL → PostgreSQL Migration Guide

This guide lists concrete steps to move the backend from MySQL to PostgreSQL.

## Checklist tổng quan
- [ ] Chuẩn bị Postgres DB và user
- [ ] Cập nhật POM và config Spring Boot
- [ ] Tạo schema mới (Hibernate auto hoặc migration script)
- [ ] Kiểm thử ứng dụng
- [ ] Setup backup & monitoring

**Lưu ý:** Guide này cho trường hợp **không cần dữ liệu cũ** - chỉ tạo schema/structure mới trên Postgres.

## 1) Chuẩn bị Postgres
- Cài Postgres server và công cụ dòng lệnh `psql`, `pg_dump`, `pg_restore` (đã có).
- Tạo DB và user:
  ```bash
  createdb seatrans
  createuser seatrans_user
  psql -c "ALTER USER seatrans_user WITH PASSWORD 'your_password';"
  psql -c "GRANT ALL PRIVILEGES ON DATABASE seatrans TO seatrans_user;"
  ```

- **Cấp quyền schema (Postgres 15+):**
  ```bash
  psql -d seatrans -c "GRANT ALL ON SCHEMA public TO seatrans_user;"
  psql -d seatrans -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO seatrans_user;"
  psql -d seatrans -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO seatrans_user;"
  psql -d seatrans -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO seatrans_user;"
  psql -d seatrans -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO seatrans_user;"
  ```

- Bật extension cần thiết sớm (tùy nhu cầu):
  ```bash
  psql -d seatrans -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"
  psql -d seatrans -c "CREATE EXTENSION IF NOT EXISTS pgcrypto;"
  ```

## 2) Chuyển dependency và cấu hình Spring Boot

### Sửa pom.xml
- **Xóa dependency MySQL:**
  ```xml
  <!-- XÓA block này -->
  <dependency>
      <groupId>com.mysql</groupId>
      <artifactId>mysql-connector-j</artifactId>
      <scope>runtime</scope>
  </dependency>
  ```

- **Thêm dependency PostgreSQL:**
  ```xml
  <!-- THÊM block này -->
  <dependency>
      <groupId>org.postgresql</groupId>
      <artifactId>postgresql</artifactId>
      <scope>runtime</scope>
  </dependency>
  ```

### Sửa application.properties
- File: `src/main/resources/application.properties` (dev):
  ```properties
  spring.datasource.url=jdbc:postgresql://localhost:5432/seatrans
  spring.datasource.username=seatrans_user
  spring.datasource.password=your_password
  spring.datasource.driver-class-name=org.postgresql.Driver
  spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
  spring.jpa.hibernate.ddl-auto=update  # chỉ dev; prod nên dùng migration
  
  # Timezone (tương đương serverTimezone=Asia/Ho_Chi_Minh của MySQL)
  spring.jpa.properties.hibernate.jdbc.time_zone=Asia/Ho_Chi_Minh
  ```

- **Lưu ý:** Bỏ các param MySQL như `createDatabaseIfNotExist`, `useSSL`, `allowPublicKeyRetrieval`.
- Nếu có profile khác (prod), cập nhật tương tự qua env vars hoặc file riêng.

## 3) Tạo schema mới trên Postgres

### Cách 1: Để Hibernate tự động tạo (nhanh cho dev)
- Với `spring.jpa.hibernate.ddl-auto=update` trong config, Hibernate sẽ tự tạo bảng khi app chạy.
- Lần đầu chạy app, Hibernate sẽ scan entities và tạo schema tương ứng.
- **Ưu điểm:** Không cần viết SQL thủ công.
- **Nhược điểm:** Không kiểm soát được chi tiết (indexes, constraints đặc biệt).

### Cách 2: Dùng migration tool (khuyên dùng cho production)
- Cài Flyway hoặc Liquibase:
  ```xml
  <!-- Thêm vào pom.xml -->
  <dependency>
      <groupId>org.flywaydb</groupId>
      <artifactId>flyway-core</artifactId>
  </dependency>
  <dependency>
      <groupId>org.flywaydb</groupId>
      <artifactId>flyway-database-postgresql</artifactId>
  </dependency>
  ```
- Tạo migration scripts trong `src/main/resources/db/migration/`:
  - `V1__create_tables.sql`
  - `V2__add_indexes.sql`
- Flyway sẽ tự chạy khi app start.

### Cách 3: Chuyển đổi schema MySQL thủ công
- Xuất schema MySQL: `mysqldump --no-data -u root -p seatrans > schema_mysql.sql`
- Chỉnh cú pháp theo Postgres (xem phần chuyển đổi bên dưới)
- Chạy trên Postgres: `psql -U seatrans_user -d seatrans -f schema_postgres.sql`

### Các chuyển đổi cú pháp cần lưu ý
- `AUTO_INCREMENT` → `GENERATED BY DEFAULT AS IDENTITY` (hoặc `SERIAL`).
- `TINYINT(1)` → `BOOLEAN`.
- `DATETIME`/`TIMESTAMP` → `TIMESTAMP WITH TIME ZONE` (khuyên dùng) hoặc `TIMESTAMP`.
- `JSON` → `JSONB`.
- `ENUM` MySQL → `TEXT` + CHECK hoặc type ENUM Postgres.
- `ON DUPLICATE KEY UPDATE` → `INSERT ... ON CONFLICT (cols) DO UPDATE`.
- `DATE_ADD/DATE_SUB` → `NOW() + interval '...'`.
- Chuỗi: `CONCAT(a,b)` → `a || b` hoặc `concat(a,b)`.

## 4) Rà soát code
- Tìm native query/hàm MySQL đặc thù trong repositories/services; chuyển cú pháp sang Postgres hoặc đổi sang JPQL.
- Migration SQL thủ công (thư mục `db/migration`) cần tương thích Postgres.

## 5) Kiểm tra schema đã tạo
```bash
# Kết nối Postgres
psql -U seatrans_user -d seatrans

# Liệt kê tất cả bảng
\dt

# Kiểm tra cấu trúc bảng và foreign keys
\d+ users
\d+ provinces
\d+ ports

# Kiểm tra sequences
SELECT * FROM pg_sequences WHERE schemaname = 'public';

# Kiểm tra indexes
\di
```

## 6) Kiểm thử ứng dụng
- Chạy app với cấu hình Postgres: `mvn clean spring-boot:run`.
- Kiểm tra app khởi động thành công, không có lỗi schema.
- Tạo dữ liệu mới:
  - Đăng ký user mới
  - Tạo CRUD: provinces, ports, posts, gallery
  - Upload files
- Quan sát log SQL (đang bật `spring.jpa.show-sql=true`).
- Kiểm tra các ràng buộc: unique, foreign keys, not null.
- **Lưu ý:** DB hiện tại rỗng - cần seed dữ liệu ban đầu nếu cần (provinces, service types, v.v.).

## 7) Seed dữ liệu ban đầu (nếu cần)

Vì DB mới hoàn toàn rỗng, có thể cần seed một số dữ liệu cơ bản:

### Cách 1: Migration SQL (khuyên dùng)
- Tạo file: `src/main/resources/db/migration/V2__seed_initial_data.sql`
  ```sql
  -- Seed service types
  INSERT INTO service_types (name, description) VALUES 
    ('Freight Forwarding', 'Freight forwarding services'),
    ('Chartering', 'Ship chartering services'),
    ('Logistics', 'Logistics services');
  
  -- Seed admin user (example)
  INSERT INTO users (email, full_name, role, password) VALUES 
    ('admin@seatrans.com', 'Admin', 'ADMIN', '$2a$10$...');
  ```

### Cách 2: Spring Boot CommandLineRunner
- Tạo bean để seed khi app start lần đầu:
  ```java
  @Component
  public class DataSeeder implements CommandLineRunner {
      @Override
      public void run(String... args) {
          // Seed logic here
      }
  }
  ```

### Cách 3: Import từ CSV/JSON
- Chuẩn bị file data mẫu
- Dùng `\copy` command trong psql hoặc JDBC batch insert

## 8) Hiệu năng và vận hành

### Tạo indexes
- Kiểm tra indexes từ MySQL và tạo tương đương trên Postgres.
- Với cột `jsonb` hoặc full-text search, dùng GIN index:
  ```sql
  CREATE INDEX idx_jsonb_field ON table_name USING GIN (jsonb_column);
  ```

### Backup định kỳ
```bash
# Backup toàn bộ DB
pg_dump -U seatrans_user -d seatrans -F c -f backup_$(date +%Y%m%d).dump

# Backup chỉ schema
pg_dump -U seatrans_user -d seatrans --schema-only > schema_backup.sql

# Restore nếu cần
pg_restore -U seatrans_user -d seatrans -c backup_20260124.dump
```

### Monitoring
- Bật `pg_stat_statements`:
  ```sql
  CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
  ```
- Xem slow queries:
  ```sql
  SELECT query, mean_exec_time, calls 
  FROM pg_stat_statements 
  ORDER BY mean_exec_time DESC 
  LIMIT 10;
  ```
- Set log cho slow queries trong `postgresql.conf`:
  ```
  log_min_duration_statement = 1000  # log queries > 1s
  ```

## 9) (Tuỳ chọn) Chuẩn bị cho Supabase
- Postgres đã tương thích. Nếu dùng Supabase:
  - Bật RLS và viết policy cho bảng nhạy cảm.
  - Tạo bucket Storage nếu cần upload.
  - Dùng service key cho backend, anon key cho frontend; giữ kết nối qua Supabase client hoặc JDBC (service role).

## Troubleshooting

### Lỗi "permission denied for schema public"
```sql
GRANT ALL ON SCHEMA public TO seatrans_user;
```

### Lỗi sequence không tăng sau insert
```sql
-- Reset sequence về giá trị max hiện tại
SELECT setval('table_id_seq', (SELECT MAX(id) FROM table_name));
```

### Timezone không đúng
- Kiểm tra timezone Postgres: `SHOW timezone;`
- Set trong session: `SET timezone = 'Asia/Ho_Chi_Minh';`
- Hoặc trong `postgresql.conf`: `timezone = 'Asia/Ho_Chi_Minh'`

### Kết nối bị từ chối
- Kiểm tra `pg_hba.conf` có cho phép kết nối từ localhost:
  ```
  host    seatrans    seatrans_user    127.0.0.1/32    md5
  ```
- Restart Postgres sau khi sửa config.
